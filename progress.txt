# Audit Fix Progress

## Task 1: Add missing database indexes (DB-1) ✅
**Files changed**: `packages/db/src/schema/collections.ts`, `packages/db/src/schema/qa.ts`, `packages/db/src/schema/share-queries.ts`, `packages/db/src/schema/media-assets.ts`, `packages/db/src/schema/transcript-segments.ts`
**Migration**: `packages/db/src/migrations/0013_warm_starjammers.sql`
**Outcome**: Added 7 missing indexes — `collection_item_collection_id_idx`, `collection_item_asset_id_idx`, `qa_evidence_message_id_idx`, `qa_evidence_segment_id_idx`, `share_query_link_created_idx`, `media_asset_user_status_idx`, `transcript_segment_transcript_index_idx`. Migration generated and applied. Type checks pass.

## Task 2: Fix guardrails to fail closed (SEC-1) ✅
**Files changed**: `packages/ai/src/guardrails.ts`
**Outcome**: Changed catch block from fail-open (`{ allowed: true }`) to fail-closed with heuristic fallback. Added `heuristicCheck()` function that: (1) denies messages over 2000 chars, (2) denies messages matching 7 jailbreak/prompt-injection patterns (e.g. "ignore previous instructions", "you are now a", "system prompt", "DAN"), (3) allows everything else. Added optional `reason` field to `GuardrailResult` interface. The caller in `stream.ts` already handles denials correctly — no changes needed there. Type checks pass.

## Task 3: Add timeout to AI streaming requests (SEC-3) ✅
**Files changed**: `packages/ai/src/stream.ts`
**Outcome**: Added `timeout: { totalMs: 120_000, chunkMs: 30_000 }` to the `streamText()` call — uses AI SDK v6's built-in timeout support instead of a manual AbortController. `totalMs` caps the entire multi-step stream at 2 minutes; `chunkMs` detects a hung provider if no data arrives for 30 seconds. Added `AbortError` handling to `toUIMessageStreamResponse.onError` — returns "Response timed out. Please try again." to the user. Type checks pass.

## Task 4: Switch rate limiter to user-based with IP fallback (SEC-4) ✅
**Files changed**: `packages/api/src/middleware/rate-limit.ts`
**Outcome**: Changed rate limiter from IP-only keying to user-based with IP fallback. The `onBeforeHandle` hook now calls `auth().api.getSession()` to try to resolve the user — if authenticated, bucket key is `user:${userId}:${category}`, otherwise falls back to `ip:${clientIp}:${category}`. Session lookup is wrapped in try/catch so failures gracefully degrade to IP-based limiting. Extracted `getClientIp()` helper. All existing bucket categories unchanged (ingest: 10/min, chat: 30/min, crud: 100/min). Type checks pass.

## Task 5: Add request body size limit (API-2) ✅
**Files changed**: `apps/server/src/index.ts`
**Outcome**: Set `maxRequestBodySize: 2 * 1024 * 1024` (2MB) in the Elysia `.listen()` options. The default was 128MB which allowed arbitrarily large payloads. 2MB is sufficient for all JSON endpoints — this app doesn't handle file uploads (ingest takes URLs). Type checks pass.

