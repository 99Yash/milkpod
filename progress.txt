## Progress Tracker

### Phase 1: Type Safety & Foundations
- [x] Task 1: Branded ID types
- [x] Task 2: Shared API response types
- [x] Task 3: Replace t.Any() message validation
- [x] Task 4: Shared tool output types
- [x] Task 5: Discriminated union for asset status (included in Task 2)

### Phase 2: Critical Fixes
- [x] Task 6: Fix convertToModelMessages async (already awaited in stream.ts)
- [x] Task 7: Wire assetId/collectionId into chat context
- [x] Task 8: Resource authorization
- [x] Task 9: Handle reasoning tokens (Option A: collapsible Thinking section in message.tsx + sendReasoning: true)
- [x] Task 10: Input guardrails (gpt-4o-mini pre-check in guardrails.ts, static refusal via createUIMessageStream)

### Phase 3: Data & Persistence
- [x] Task 11: Normalize message persistence (qa_message_parts table, saveMessages/getMessages in ChatService, migration 0002)
- [x] Task 12: Embedding model versioning (added model + dimensions columns to embeddings table, constants in provider.ts, pipeline stores model info, retrieval warns on mismatch, migration 0003). Also fixed branded type mismatches in retrieval.ts, tools.ts, stream.ts, types.ts, and chat/index.ts
- [x] Task 13: Pipeline error handling & retry (withRetry utility with exponential backoff + jitter, 3 retries per stage, attempts/lastError tracked in DB, POST /api/assets/:id/retry endpoint, retry button in asset-card.tsx). Also fixed branded type system: switched from unique symbol to phantom __brand pattern, exported brand from helpers.ts, updated all services + routes to use branded ID types with casts at route boundaries.

### Phase 4: UX Improvements
- [x] Task 14: Asset detail view (new /asset/[id] route with DashboardLayout, AssetDetail client component fetches asset+transcript+segments via Eden, TranscriptViewer shows timestamped segments with speaker labels, ChatPanel reused as side panel, status polling while processing, back nav to library. Asset cards now link to detail page when ready.)
- [x] Task 15: Collection management UI (library tab Assets/Collections toggle, collection-list.tsx + collection-card.tsx with edit/delete dialogs, create-collection-dialog.tsx, add-to-collection-dialog.tsx on asset cards via FolderPlus icon, /collection/[id] detail page with member asset list + remove items + scoped Q&A ChatPanel via collectionId, add-asset-to-collection-dialog.tsx in detail view)
- [x] Task 16: Streaming progress indicators (enhanced existing SSE system: added progress field to AssetStatusEvent, emitAssetProgress helper for sub-stage progress, pipeline emits per-segment embedding progress, AssetCard uses real SSE progress mapped to overall % via stage ranges, useAssetEvents hook has auto-reconnection with exponential backoff, AssetList tracks per-asset progress map, AssetDetail shows live progress messages)
- [x] Task 17: Search and filter (API: GET /api/assets?q=&status=&sourceType= with ilike title/channelName search + inArray status/sourceType filtering in AssetService.search(), Frontend: SearchFilterBar component with debounced search input + status/sourceType Select dropdowns + clear filters, wired into LibraryTab → AssetList)

### Phase 5: Sharing & Access Control
- [x] Task 18: Share link schema & API (share_links table with id/token/userId/assetId/collectionId/canQuery/expiresAt/revokedAt, ShareLinkId branded type, ShareService with create/list/revoke/validateToken/getSharedResource, shares module with POST /api/shares, GET /api/shares, DELETE /api/shares/:id, GET /api/shares/validate/:token, crypto-random 32-char base64url tokens, ownership verification on create, expiry+revocation checks on validate, migration 0004)
- [x] Task 19: Share link UI (ShareDialog component with create link form: canQuery toggle, expiry selector, auto-copy to clipboard; lists existing active links with copy + revoke buttons; added to asset-detail.tsx and collection-detail.tsx header areas; public /share/[token] page with SharedView component that validates token via API and renders read-only transcript viewer for assets or item list for collections; enhanced ShareService.getSharedResource to load transcript+segments for assets and items for collections; rebuilt @milkpod/api dist to include shares module types)
- [x] Task 20: Rate-limited shared Q&A (already implemented in Task 19: POST /api/shares/chat/:token public endpoint with token validation, ShareService.checkRateLimit 10 queries/hour per share link, shareQueries table for audit logging, SharedChatPanel with rate limit warnings, useSharedChat hook with X-RateLimit-Remaining header extraction)

### Phase 6: Production Hardening
- [x] Task 21: Request logging middleware (packages/api/src/middleware/logger.ts: Elysia plugin with onRequest/onAfterResponse hooks, WeakMap-based request timing, structured JSON logs with level/method/path/status/durationMs/userId/timestamp, health check noise skipped, wired into packages/api/src/index.ts as first plugin)
- [x] Task 22: Rate limiting (packages/api/src/middleware/rate-limit.ts: in-memory token bucket per user per endpoint category, 3 tiers — ingest: 10/min, chat: 30/min, CRUD: 100/min, 429 with Retry-After header, falls back to IP for unauthenticated endpoints, periodic bucket cleanup for idle entries, wired into main app after session derive)
- [x] Task 23: Health checks & graceful shutdown (upgraded /health to check DB connectivity via `db.execute(sql\`SELECT 1\`)` returning JSON {status, db}, added /ready endpoint with extensible checks object returning 503 on failure, moved health+ready before auth derive so they don't require session, exported closeConnections() from @milkpod/api, graceful shutdown in apps/server via SIGTERM/SIGINT handlers that call server.stop() then closeConnections(), logger skips /ready noise)
- [x] Task 24: Error boundaries & offline handling (global-error.tsx for root-level crashes, error.tsx at root/dashboard/asset/collection/share routes with contextual messages + retry buttons + nav links, not-found.tsx for 404s, OfflineBanner component with online/offline event listeners showing fixed banner when disconnected, wired into Providers)
